def sysenv = System.getenv()

ext.ciType = ({
    if ("JENKINS_URL" in sysenv.keySet()) {
        "Jenkins"
    } else if ("TRAVIS_BUILD_NUMBER" in sysenv.keySet()) {
        "Travis CI"
    } else {
        "Unknown"
    }
})()

ext.uploadTestReports = { ->
    project.exec {
        commandLine "git", "clone", "https://${System.getenv('UPLOAD_USERNAME')}:${System.getenv('UPLOAD_PASSWORD')}@github.com/DirectMyFile/tests.git", "tmp/"
    }
    project.exec {
        commandLine "bash", "tmp/copy.sh", "JPower", "${project.buildDir}/reports/allTests/"
    }
    project.exec {
        commandLine "git", "add", "."
    }
    project.exec {
        commandLine "git", "commit", "-m", "Updated Tests for JPower"
    }
    project.exec {
        commandLine "git", "push", "origin", "gh-pages"
    }
    new File("tmp").deleteDir()
}

task ci {
    group = "build"
    description = "Executes a Build for Continuous Integration"

    for (prj in subprojects) {
        finalizedBy ":${prj.name}:test", ":${prj.name}:jar"
        if (!(ciType in ["Travis CI", "Unknown"]))
            finalizedBy ":${prj.name}:publish"
    }

    finalizedBy "jarAll", "javadocAll", "allTestsReport"

    doFirst {
        if (ciType == "Unknown") {
            logger.lifecycle "[CI Build] Cannot detect CI Type"
        }
    }
}

